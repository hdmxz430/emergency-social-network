<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for f17-ESN-SA4/controllers/poll_controller.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">f17-ESN-SA4/controllers/</a> poll_controller.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">85.48% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>53/62</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">66.67% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>8/12</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>8/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">85.48% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>53/62</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">const _ = require('lodash');
const poll = require("../models/poll");
let User = require('../models/user');
const moment = require("moment");
&nbsp;
let gotoPoll= (req, res) =&gt; {
<span class="cstat-no" title="statement not covered" >    let currentUser = _.pick(req.user, ['username']);</span>
<span class="cstat-no" title="statement not covered" >    res.render('poll', {currentUser: currentUser.username});</span>
};
let gotoPolldetail= (req, res) =&gt; {
<span class="cstat-no" title="statement not covered" >    let currentUser = _.pick(req.user, ['username']);</span>
<span class="cstat-no" title="statement not covered" >    res.render('poll_detail', {currentUser: currentUser.username});</span>
};
&nbsp;
let getPollList = (req, res) =&gt; {
    poll.getPollList().then(function (polllist) {
        res.status(200).send({ polllist: polllist});
    }).catch(err =&gt; {
<span class="cstat-no" title="statement not covered" >        res.status(500).send({message: err});</span>
    });
};
let getPollDetail = (req, res) =&gt; {
    poll.findByID(req.query.id).then(function (poll) {
        res.send({status: 200, poll: poll});
    }).catch(err =&gt; {
<span class="cstat-no" title="statement not covered" >        res.status(500).send({message: err});</span>
    });
};
&nbsp;
let postPoll = (req, res) =&gt; {
    let created_by = req.body.username;
    let created_at = moment.now().valueOf();
    let description = req.body.description;
    let opt = req.body.option;
    let token = req.body.token;
    let pollname=req.body.pollname;
    let expire=req.body.expire;
    const io = require('../app').io; //For Now
    User.findByToken(token).then(function (username_) {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!(created_by === username_.get("username"))) {
<span class="cstat-no" title="statement not covered" >            return Promise.reject("token not matched with sender");</span>
        } else {
            let options=opt.trim().split("\n");
            if(options.length&lt;=1){
                return Promise.reject("There should be at least 2 options");
            }
            if(pollname.trim()===''){
                return Promise.reject("Title cannot be empty");
            }
            return poll.postPoll(pollname,description,expire,created_at,created_by,options);
        }
    }).then(function (p) {
        io.emit("poll posted", "1");
        res.status(201).send({});
    }).catch(function (err) {
        console.log(err);
        res.status(400).send({message: err});
    });
};
&nbsp;
let vote = (req, res) =&gt; {
    let username = req.body.username;
    let token = req.body.token;
    let id=req.body.id;
    let time=moment.now().valueOf();
    let option=req.body.option;
    const io = require('../app').io;
    User.findByToken(token).then(function (username_) {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!(username === username_.get("username"))) {
<span class="cstat-no" title="statement not covered" >            return Promise.reject("token not matched with sender");</span>
        } else {
            return poll.findByID(id).then((poll_)=&gt;{
                <span class="missing-if-branch" title="if path not taken" >I</span>if(time&gt;poll_.timestamp){
<span class="cstat-no" title="statement not covered" >                    return Promise.reject("This poll is expired");</span>
                }
                for(let i=0;i&lt;poll_.voted.length;i++){
                    <span class="missing-if-branch" title="else path not taken" >E</span>if(poll_.voted[i]===username){
                        return Promise.reject("You have voted");
                    }
                }
                return poll.votePoll(id,username,option);
            })
        }
    }).then(function (p) {
        io.emit("vote "+id, "1");
        res.status(200).send({});
    }).catch(function (err) {
        console.log(err);
        res.status(400).send({message: err});
    });
};
&nbsp;
module.exports = {gotoPoll,gotoPolldetail,vote,postPoll,getPollList,getPollDetail};
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Nov 29 2017 10:56:46 GMT-0800 (PST)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
